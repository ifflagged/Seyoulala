console.log(" iRingo: ✈ TestFlight"),console.log("request.bundle.js"),console.log("Version: 3.4.0"),console.log("Date: 2024/12/24 16:53:50"),(()=>{"use strict";let e;var t={},s={};function a(e){var r=s[e];if(void 0!==r)return r.exports;var i=s[e]={exports:{}};return t[e](i,i.exports,a),i.exports}a.rv=function(){return"1.1.8"},a.ruid="bundler=rspack@1.1.8";let r=(()=>{let e=Object.keys(globalThis);switch(!0){case e.includes("$task"):return"Quantumult X";case e.includes("$loon"):return"Loon";case e.includes("$rocket"):return"Shadowrocket";case"undefined"!=typeof module:return"Node.js";case e.includes("Egern"):return"Egern";case e.includes("$environment"):if($environment["surge-version"])return"Surge";if($environment["stash-version"])return"Stash";return;default:return}})();class i{static #e=new Map([]);static #t=[];static #s=new Map([]);static clear=()=>{};static count=(e="default")=>{switch(i.#e.has(e)){case!0:i.#e.set(e,i.#e.get(e)+1);break;case!1:i.#e.set(e,0)}i.log(`${e}: ${i.#e.get(e)}`)};static countReset=(e="default")=>{switch(i.#e.has(e)){case!0:i.#e.set(e,0),i.log(`${e}: ${i.#e.get(e)}`);break;case!1:i.warn(`Counter "${e}" doesn’t exist`)}};static debug=(...e)=>{!(i.#a<4)&&(e=e.map(e=>`🅱️ ${e}`),i.log(...e))};static error(...e){if(!(i.#a<1)){switch(r){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Quantumult X":default:e=e.map(e=>`❌ ${e}`);break;case"Node.js":e=e.map(e=>`❌ ${e.stack}`)}i.log(...e)}}static exception=(...e)=>i.error(...e);static group=e=>i.#t.unshift(e);static groupEnd=()=>i.#t.shift();static info(...e){!(i.#a<3)&&(e=e.map(e=>`ℹ️ ${e}`),i.log(...e))}static #a=3;static get logLevel(){switch(i.#a){case 0:return"OFF";case 1:return"ERROR";case 2:return"WARN";case 3:default:return"INFO";case 4:return"DEBUG";case 5:return"ALL"}}static set logLevel(e){switch(typeof e){case"string":e=e.toLowerCase();break;case"number":break;default:e="warn"}switch(e){case 0:case"off":i.#a=0;break;case 1:case"error":i.#a=1;break;case 2:case"warn":case"warning":default:i.#a=2;break;case 3:case"info":i.#a=3;break;case 4:case"debug":i.#a=4;break;case 5:case"all":i.#a=5}}static log=(...e)=>{0!==i.#a&&(e=e.map(e=>{switch(typeof e){case"object":e=JSON.stringify(e);break;case"bigint":case"number":case"boolean":case"string":e=e.toString()}return e}),i.#t.forEach(t=>{(e=e.map(e=>`  ${e}`)).unshift(`▼ ${t}:`)}),console.log((e=["",...e]).join("\n")))};static time=(e="default")=>i.#s.set(e,Date.now());static timeEnd=(e="default")=>i.#s.delete(e);static timeLog=(e="default")=>{let t=i.#s.get(e);t?i.log(`${e}: ${Date.now()-t}ms`):i.warn(`Timer "${e}" doesn’t exist`)};static warn(...e){!(i.#a<2)&&(e=e.map(e=>`⚠️ ${e}`),i.log(...e))}}class o{static escape(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,e=>t[e])}static get(e={},t="",s){!Array.isArray(t)&&(t=o.toPath(t));let a=t.reduce((e,t)=>Object(e)[t],e);return void 0===a?s:a}static omit(e={},t=[]){return!Array.isArray(t)&&(t=[t.toString()]),t.forEach(t=>o.unset(e,t)),e}static pick(e={},t=[]){return!Array.isArray(t)&&(t=[t.toString()]),Object.fromEntries(Object.entries(e).filter(([e,s])=>t.includes(e)))}static set(e,t,s){return!Array.isArray(t)&&(t=o.toPath(t)),t.slice(0,-1).reduce((e,s,a)=>Object(e[s])===e[s]?e[s]:e[s]=/^\d+$/.test(t[a+1])?[]:{},e)[t[t.length-1]]=s,e}static toPath(e){return e.replace(/\[(\d+)\]/g,".$1").split(".").filter(Boolean)}static unescape(e){let t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,e=>t[e])}static unset(e={},t=""){return!Array.isArray(t)&&(t=o.toPath(t)),t.reduce((e,s,a)=>a===t.length-1?(delete e[s],!0):Object(e)[s],e)}}let n={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",304:"Not Modified",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Content Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"};function c(e={}){switch(r){case"Surge":e.policy&&o.set(e,"headers.X-Surge-Policy",e.policy),i.log("\uD83D\uDEA9 执行结束!",`🕛 ${new Date().getTime()/1e3-$script.startTime} 秒`),$done(e);break;case"Loon":e.policy&&(e.node=e.policy),i.log("\uD83D\uDEA9 执行结束!",`🕛 ${(new Date-$script.startTime)/1e3} 秒`),$done(e);break;case"Stash":e.policy&&o.set(e,"headers.X-Stash-Selected-Proxy",encodeURI(e.policy)),i.log("\uD83D\uDEA9 执行结束!",`🕛 ${(new Date-$script.startTime)/1e3} 秒`),$done(e);break;case"Egern":case"Shadowrocket":i.log("\uD83D\uDEA9 执行结束!"),$done(e);break;case"Quantumult X":switch(e.policy&&o.set(e,"opts.policy",e.policy),typeof(e=o.pick(e,["status","url","headers","body","bodyBytes"])).status){case"number":e.status=`HTTP/1.1 ${e.status} ${n[e.status]}`;break;case"string":case"undefined":break;default:throw TypeError(`${Function.name}: 参数类型错误, status 必须为数字或字符串`)}e.body instanceof ArrayBuffer?(e.bodyBytes=e.body,e.body=void 0):ArrayBuffer.isView(e.body)?(e.bodyBytes=e.body.buffer.slice(e.body.byteOffset,e.body.byteLength+e.body.byteOffset),e.body=void 0):e.body&&(e.bodyBytes=void 0),i.log("\uD83D\uDEA9 执行结束!"),$done(e);break;default:i.log("\uD83D\uDEA9 执行结束!"),process.exit(1)}}let l=e=>{let t={};switch(typeof e){case void 0:break;case"string":case"number":case"boolean":switch($app){case"Surge":case"Stash":case"Egern":default:t.url=e;break;case"Loon":case"Shadowrocket":t.openUrl=e;break;case"Quantumult X":t["open-url"]=e;case"Node.js":}break;case"object":{let s=e.open||e["open-url"]||e.url||e.openUrl,a=e.copy||e["update-pasteboard"]||e.updatePasteboard,r=e.media||e["media-url"]||e.mediaUrl;switch($app){case"Surge":case"Stash":case"Egern":case"Shadowrocket":default:if(s&&(t.action="open-url",t.url=s),a&&(t.action="clipboard",t.text=a),r)switch(!0){case r.startsWith("http"):t["media-url"]=r;break;case r.startsWith("data:"):{let{MIME:s,Base64:a}=r.match(/^data:(?<MIME>\w+\/\w+);base64,(?<Base64>.+)/).groups;t["media-base64"]=a,t["media-base64-mime"]=e.mime||s;break}default:switch(t["media-base64"]=r,!0){case r.startsWith("CiVQREYt"):case r.startsWith("JVBERi0"):t["media-base64-mime"]="application/pdf";break;case r.startsWith("R0lGODdh"):case r.startsWith("R0lGODlh"):t["media-base64-mime"]="image/gif";break;case r.startsWith("iVBORw0KGgo"):t["media-base64-mime"]="image/png";break;case r.startsWith("/9j/"):t["media-base64-mime"]="image/jpg";break;case r.startsWith("Qk02U"):t["media-base64-mime"]="image/bmp"}}e["auto-dismiss"]&&(t["auto-dismiss"]=e["auto-dismiss"]),e.sound&&(t.sound=e.sound);break;case"Loon":s&&(t.openUrl=s),r?.startsWith("http")&&(t.mediaUrl=r);break;case"Quantumult X":s&&(t["open-url"]=s),r?.startsWith("http")&&(t["media-url"]=r),a&&(t["update-pasteboard"]=a);case"Node.js":}break}default:Console.error(`不支持的通知参数类型: ${typeof e}`,"")}return t};class h{static data=null;static dataFile="box.dat";static #r=/^@(?<key>[^.]+)(?:\.(?<path>.*))?$/;static getItem(e,t=null){let s=t;if(!0===e.startsWith("@")){let{key:t,path:a}=e.match(h.#r)?.groups;e=t;let r=h.getItem(e,{});"object"!=typeof r&&(r={}),s=o.get(r,a);try{s=JSON.parse(s)}catch(e){}}else{switch(r){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":s=$persistentStore.read(e);break;case"Quantumult X":s=$prefs.valueForKey(e);break;case"Node.js":h.data=h.#i(h.dataFile),s=h.data?.[e];break;default:s=h.data?.[e]||null}try{s=JSON.parse(s)}catch(e){}}return s??t}static setItem(e=new String,t=new String){let s=!1;if("object"==typeof t)t=JSON.stringify(t);else t=String(t);if(!0===e.startsWith("@")){let{key:a,path:r}=e.match(h.#r)?.groups;e=a;let i=h.getItem(e,{});"object"!=typeof i&&(i={}),o.set(i,r,t),s=h.setItem(e,i)}else switch(r){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":s=$persistentStore.write(t,e);break;case"Quantumult X":s=$prefs.setValueForKey(t,e);break;case"Node.js":h.data=h.#i(h.dataFile),h.data[e]=t,h.#o(h.dataFile),s=!0;break;default:s=h.data?.[e]||null}return s}static removeItem(e){let t=!1;if(!0===e.startsWith("@")){let{key:s,path:a}=e.match(h.#r)?.groups;e=s;let r=h.getItem(e);"object"!=typeof r&&(r={}),keyValue=o.unset(r,a),t=h.setItem(e,r)}else switch(r){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":t=!1;break;case"Quantumult X":t=$prefs.removeValueForKey(e);break;default:t=!1}return t}static clear(){let e=!1;switch(r){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":e=!1;break;case"Quantumult X":e=$prefs.removeAllValues();break;default:e=!1}return e}static #i=e=>{if("Node.js"!==r)return{};{this.fs=this.fs?this.fs:require("node:fs"),this.path=this.path?this.path:require("node:path");let t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),r=!a&&this.fs.existsSync(s);if(!a&&!r)return{};try{return JSON.parse(this.fs.readFileSync(a?t:s))}catch(e){return{}}}};static #o=(e=this.dataFile)=>{if("Node.js"===r){this.fs=this.fs?this.fs:require("node:fs"),this.path=this.path?this.path:require("node:path");let t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),r=!a&&this.fs.existsSync(s),i=JSON.stringify(this.data);a?this.fs.writeFileSync(t,i):r?this.fs.writeFileSync(s,i):this.fs.writeFileSync(t,i)}}}function u(e){return/^\d+$/.test(e)&&(e=Number.parseInt(e,10)),e}class d{constructor(e){switch(typeof e){case"string":if(0===e.length)break;e.startsWith("?")&&(e=e.slice(1)),e.split("&").map(e=>e.split("=")).forEach(([e,t])=>{this.#n.push(e?decodeURIComponent(e):e),this.#c.push(t?decodeURIComponent(t):t)});break;case"object":if(Array.isArray(e))Object.entries(e).forEach(([e,t])=>{this.#n.push(e?decodeURIComponent(e):e),this.#c.push(t?decodeURIComponent(t):t)});else if(Symbol.iterator in Object(e))for(let[t,s]of e)this.#n.push(t?decodeURIComponent(t):t),this.#c.push(s?decodeURIComponent(s):s)}this.#l(this.#n,this.#c)}#h="";#n=[];#c=[];#l(e,t){0===e.length?this.#h="":this.#h=e.map((e,s)=>{switch(typeof t[s]){case"object":return`${encodeURIComponent(e)}=${encodeURIComponent(JSON.stringify(t[s]))}`;case"boolean":case"number":case"string":return`${encodeURIComponent(e)}=${encodeURIComponent(t[s])}`;default:return encodeURIComponent(e)}}).join("&")}append(e,t){e=decodeURIComponent(e),t&&(t=decodeURIComponent(t)),this.#n.push(e),this.#c.push(t),this.#l(this.#n,this.#c)}delete(e,t){for(e=decodeURIComponent(e),t&&(t=decodeURIComponent(t));this.#n.indexOf(e)>-1;)this.#c.splice(this.#n.indexOf(e),1),this.#n.splice(this.#n.indexOf(e),1);this.#l(this.#n,this.#c)}entries(){return this.#n.map((e,t)=>[e,this.#c[t]])}get(e){return e=decodeURIComponent(e),this.#c[this.#n.indexOf(e)]}getAll(e){return e=decodeURIComponent(e),this.#c.filter((t,s)=>this.#n[s]===e)}has(e,t){return e=decodeURIComponent(e),t&&(t=decodeURIComponent(t)),this.#n.indexOf(e)>-1}keys(){return this.#n}set(e,t){if(e=decodeURIComponent(e),t&&(t=decodeURIComponent(t)),-1===this.#n.indexOf(e))this.append(e,t);else{let s=!0,a=[];this.#n=this.#n.filter((r,i)=>r!==e?(a.push(this.#c[i]),!0):!!s&&(s=!1,a.push(t),!0)),this.#c=a,this.#l(this.#n,this.#c)}}sort(){let e=this.entries().sort();this.#n=[],this.#c=[],e.forEach(e=>{this.#n.push(e[0]),this.#c.push(e[1])}),this.#l(this.#n,this.#c)}toString=()=>this.#h;values=()=>this.#c.values()}class p{constructor(e,t){switch(typeof e){case"string":{let s=/^(blob:|file:)?[a-zA-z]+:\/\/.*/.test(e),a=!!t&&/^(blob:|file:)?[a-zA-z]+:\/\/.*/.test(t);if(s)this.href=e;else if(a)this.href=t+e;else throw TypeError('URL string is not valid. If using a relative url, a second argument needs to be passed representing the base URL. Example: new URL("relative/path", "http://www.example.com");');break}case"object":break;default:throw TypeError("Invalid argument type.")}}#u={hash:"",host:"",hostname:"",href:"",password:"",pathname:"",port:Number.NaN,protocol:"",search:"",searchParams:new d(""),username:""};static #d=/^(?<scheme>([^:\/?#]+):)?(?:\/\/(?<authority>[^\/?#]*))?(?<path>[^?#]*)(?<query>\?([^#]*))?(?<hash>#(.*))?$/;static #p=/^(?<authentication>(?<username>[^:]*)(:(?<password>[^@]*))?@)?(?<hostname>[^:]+)(:(?<port>\d+))?$/;get hash(){return this.#u.hash}set hash(e){0!==e.length&&(e.startsWith("#")&&(e=e.slice(1)),this.#u.hash=`#${encodeURIComponent(e)}`)}get host(){return this.port.length>0?`${this.hostname}:${this.port}`:this.hostname}set host(e){[this.hostname,this.port]=e.split(":",2)}get hostname(){return encodeURIComponent(this.#u.hostname)}set hostname(e){this.#u.hostname=e??""}get href(){let e="";return this.username.length>0&&(e+=this.username,this.password.length>0&&(e+=`:${this.password}`),e+="@"),`${this.protocol}//${e}${this.host}${this.pathname}${this.search}${this.hash}`}set href(e){(e.startsWith("blob:")||e.startsWith("file:"))&&(e=e.slice(5));let t=e.match(p.#d);if(!t)throw TypeError("Invalid URL format.");this.protocol=t.groups.scheme??"";let s=t.groups.authority.match(p.#p);this.username=s.groups.username??"",this.password=s.groups.password??"",this.hostname=s.groups.hostname??"",this.port=s.groups.port??"",this.pathname=t.groups.path??"",this.search=t.groups.query??"",this.hash=t.groups.hash??""}get origin(){return`${this.protocol}//${this.host}`}get password(){return encodeURIComponent(this.#u.password)}set password(e){this.username.length>0&&(this.#u.password=e??"")}get pathname(){return`/${this.#u.pathname}`}set pathname(e){(e=`${e}`).startsWith("/")&&(e=e.slice(1)),this.#u.pathname=e}get port(){if(Number.isNaN(this.#u.port))return"";let e=this.#u.port.toString();return"ftp:"===this.protocol&&"21"===e||"http:"===this.protocol&&"80"===e||"https:"===this.protocol&&"443"===e?"":e}set port(e){if(""===e)this.#u.port=Number.NaN;else{let t=Number.parseInt(e,10);t>=0&&t<65535&&(this.#u.port=t)}}get protocol(){return`${this.#u.protocol}:`}set protocol(e){e.endsWith(":")&&(e=e.slice(0,-1)),this.#u.protocol=e}get search(){return(this.#u.search=this.searchParams.toString(),this.#u.search.length>0)?`?${this.#u.search}`:""}set search(e){(e=`${e}`).startsWith("?")&&(e=e.slice(1)),this.#u.search=e,this.#u.searchParams=new d(this.#u.search)}get searchParams(){return this.#u.searchParams}get username(){return encodeURIComponent(this.#u.username)}set username(e){this.#u.username=e??""}static parse=(e,t)=>new p(e,t);toString=()=>this.href;toJSON=()=>JSON.stringify({hash:this.hash,host:this.host,hostname:this.hostname,href:this.href,origin:this.origin,password:this.password,pathname:this.pathname,port:this.port,protocol:this.protocol,search:this.search,searchParams:this.searchParams,username:this.username})}let m={Testflight:{Settings:{CountryCode:"US",MultiAccount:!1,Universal:!0,AlwaysShowInstall:!1,MergeNotifications:!1}},Default:{Settings:{LogLevel:"WARN"},Configs:{Storefront:{AE:"143481",AF:"143610",AG:"143540",AI:"143538",AL:"143575",AM:"143524",AO:"143564",AR:"143505",AT:"143445",AU:"143460",AZ:"143568",BA:"143612",BB:"143541",BD:"143490",BE:"143446",BF:"143578",BG:"143526",BH:"143559",BJ:"143576",BM:"143542",BN:"143560",BO:"143556",BR:"143503",BS:"143539",BT:"143577",BW:"143525",BY:"143565",BZ:"143555",CA:"143455",CD:"143613",CG:"143582",CH:"143459",CI:"143527",CL:"143483",CM:"143574",CN:"143465",CO:"143501",CR:"143495",CV:"143580",CY:"143557",CZ:"143489",DE:"143443",DK:"143458",DM:"143545",DO:"143508",DZ:"143563",EC:"143509",EE:"143518",EG:"143516",ES:"143454",FI:"143447",FJ:"143583",FM:"143591",FR:"143442",GA:"143614",GB:"143444",GD:"143546",GF:"143615",GH:"143573",GM:"143584",GR:"143448",GT:"143504",GW:"143585",GY:"143553",HK:"143463",HN:"143510",HR:"143494",HU:"143482",ID:"143476",IE:"143449",IL:"143491",IN:"143467",IQ:"143617",IS:"143558",IT:"143450",JM:"143511",JO:"143528",JP:"143462",KE:"143529",KG:"143586",KH:"143579",KN:"143548",KP:"143466",KR:"143466",KW:"143493",KY:"143544",KZ:"143517",TC:"143552",TD:"143581",TJ:"143603",TH:"143475",TM:"143604",TN:"143536",TO:"143608",TR:"143480",TT:"143551",TW:"143470",TZ:"143572",LA:"143587",LB:"143497",LC:"143549",LI:"143522",LK:"143486",LR:"143588",LT:"143520",LU:"143451",LV:"143519",LY:"143567",MA:"143620",MD:"143523",ME:"143619",MG:"143531",MK:"143530",ML:"143532",MM:"143570",MN:"143592",MO:"143515",MR:"143590",MS:"143547",MT:"143521",MU:"143533",MV:"143488",MW:"143589",MX:"143468",MY:"143473",MZ:"143593",NA:"143594",NE:"143534",NG:"143561",NI:"143512",NL:"143452",NO:"143457",NP:"143484",NR:"143606",NZ:"143461",OM:"143562",PA:"143485",PE:"143507",PG:"143597",PH:"143474",PK:"143477",PL:"143478",PT:"143453",PW:"143595",PY:"143513",QA:"143498",RO:"143487",RS:"143500",RU:"143469",RW:"143621",SA:"143479",SB:"143601",SC:"143599",SE:"143456",SG:"143464",SI:"143499",SK:"143496",SL:"143600",SN:"143535",SR:"143554",ST:"143598",SV:"143506",SZ:"143602",UA:"143492",UG:"143537",US:"143441",UY:"143514",UZ:"143566",VC:"143550",VE:"143502",VG:"143543",VN:"143471",VU:"143609",XK:"143624",YE:"143571",ZA:"143472",ZM:"143622",ZW:"143605"}}}};let g=new p($request.url);i.info(`url: ${g.toJSON()}`);let f=g.pathname.split("/").filter(Boolean);i.info(`PATHs: ${f}`);let b=($request.headers?.["Content-Type"]??$request.headers?.["content-type"])?.split(";")?.[0];i.info(`FORMAT: ${b}`),(async()=>{let{Settings:e,Caches:t,Configs:s}=function(e,t,s){i.log("☑️ Set Environment Variables");let{Settings:a,Caches:r,Configs:n}=function(e,t,s){t=[t].flat(Number.POSITIVE_INFINITY);let a={Settings:s?.Default?.Settings||{},Configs:s?.Default?.Configs||{},Caches:{}};switch(t.forEach(e=>{a.Settings={...a.Settings,...s?.[e]?.Settings},a.Configs={...a.Configs,...s?.[e]?.Configs}}),typeof $argument){case"string":$argument=Object.fromEntries($argument.split("&").map(e=>e.split("=",2).map(e=>e.replace(/\"/g,""))));case"object":{let e={};Object.keys($argument).forEach(t=>o.set(e,t,$argument[t])),a.Settings={...a.Settings,...e}}}let r=h.getItem(e);return r&&t.forEach(e=>{switch(typeof r?.[e]?.Settings){case"string":r[e].Settings=JSON.parse(r[e].Settings||"{}");case"object":a.Settings={...a.Settings,...r[e].Settings}}switch(typeof r?.[e]?.Caches){case"string":r[e].Caches=JSON.parse(r[e].Caches||"{}");case"object":a.Caches={...a.Caches,...r[e].Caches}}}),function e(t,s){for(let a in t){let r=t[a];t[a]="object"==typeof r&&null!==r?e(r,s):s(a,r)}return t}(a.Settings,(e,t)=>("true"===t||"false"===t?t=JSON.parse(t):"string"==typeof t&&(t=t.includes(",")?t.split(",").map(e=>u(e)):u(t)),t)),a}(e,t,s);if(i.info(`typeof Settings: ${typeof a}`,`Settings: ${JSON.stringify(a,null,2)}`),n.Locale&&(n.Locale=new Map(n.Locale)),n.i18n)for(let e in n.i18n)n.i18n[e]=new Map(n.i18n[e]);return i.log("✅ Set Environment Variables"),{Settings:a,Caches:r,Configs:n}}("iRingo","TestFlight",m);i.logLevel=e.LogLevel;let a={};switch($request.method){case"POST":case"PUT":case"PATCH":case"DELETE":switch(b){case void 0:case"application/x-www-form-urlencoded":case"text/plain":default:case"application/x-mpegURL":case"application/x-mpegurl":case"application/vnd.apple.mpegurl":case"audio/mpegurl":case"text/xml":case"text/html":case"text/plist":case"application/xml":case"application/plist":case"application/x-plist":case"text/vtt":case"application/vtt":break;case"text/json":case"application/json":if(a=JSON.parse($request.body??"{}"),"testflight.apple.com"===g.hostname)switch(g.pathname){case"/v1/session/authenticate":"AUTO"!==e.CountryCode&&(a.storeFrontIdentifier=a.storeFrontIdentifier.replace(/\d{6}/,s.Storefront[e.CountryCode]));break;case"/v1/properties/testflight":case"/v1/devices":case"/v1/devices/apns":case"/v1/devices/add":case"/v1/devices/remove":break;default:switch(f[0]){case"v1":case"v2":case"v3":if("accounts"===f[1])switch(f[2]){case"settings":if("notifications"===f[3]){if("apps"===f[4]){if(void 0===f[5])i.debug(`/${f[0]}/accounts/${f[2]}/settings/notifications/apps`);else switch(i.debug(`/${f[0]}/accounts/${f[2]}/settings/notifications/apps/${f[5]}`),e.MergeNotifications){case!0:default:{i.info("合并通知");let e=function(e){i.log("☑️ Detect Platform");let t="ios";switch(!0){case/iPhone|iPad|iOS|iPadOS/i.test(e):t="ios";break;case/Macintosh|macOS/i.test(e):t="osx";break;case/Apple TV|tvOS/i.test(e):t="appletvos";break;case/Watch|watchOS/i.test(e):t="watchos";break;case/Vision Pro|xrOS/i.test(e):t="xros"}return i.log("✅ Detect Platform",`Platform: ${t}`),t}($request.headers?.["User-Agent"]??$request.headers?.["user-agent"]),t=o.get(a,`platformUpdates.${e}.emailEnabled`);i.info(`EmailEnabled: ${t}`),o.set(a,"platformUpdates.appletvos.emailEnabled",t),o.set(a,"platformUpdates.ios.emailEnabled",t),o.set(a,"platformUpdates.osx.emailEnabled",t),o.set(a,"platformUpdates.xros.emailEnabled",t);break}case!1:i.info("不合并通知")}}}break;case t?.data?.accountId:default:if("apps"===f[3]){f[4];if("builds"===f[5])switch(f[7]){case void 0:break;case"install":"AUTO"!==e.CountryCode&&(a.storefrontId=a.storefrontId.replace(/\d{6}/,s.Storefront[e.CountryCode]))}}}}}$request.body=JSON.stringify(a);case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":case"application/grpc":case"application/grpc+proto":case"applecation/octet-stream":}case"GET":case"HEAD":case"OPTIONS":default:if("testflight.apple.com"===g.hostname)switch(g.pathname){case"/v1/session/authenticate":case"v1/properties/testflight":case"/v1/devices":case"/v1/devices/apns":case"/v1/devices/add":case"/v1/devices/remove":break;default:if(!0===e.MultiAccount){i.info("启用多账号支持");let e=$request?.headers?.["If-None-Match"]??$request?.headers?.["if-none-match"],s=$request?.headers?.["X-Request-Id"]??$request?.headers?.["x-request-id"],a=$request?.headers?.["X-Session-Id"]??$request?.headers?.["x-session-id"],r=$request?.headers?.["X-Session-Digest"]??$request?.headers?.["x-session-digest"];if(t.data)switch(i.info("Caches.data存在，读取"),f[0]){case"v1":case"v2":case"v3":switch(f[1]){case"accounts":case"messages":case"apps":default:switch(f[2]){case"settings":case void 0:default:switch(/[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}/.test(f[2])){case!0:i.info("PATHs[2]是UUID，替换url.pathname"),g.pathname=g.pathname.replace(/\/[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}\//i,`/${t.data.accountId}/`);case!1:a!==t.headers["X-Session-Id"]&&(i.info("sessionId不同，替换$request.headers"),e&&(delete $request.headers?.["If-None-Match"],delete $request.headers?.["if-none-match"]),s&&($request.headers?.["X-Request-Id"]&&($request.headers["X-Request-Id"]=t.headers["X-Request-Id"]),$request.headers?.["x-request-id"]&&($request.headers["x-request-id"]=t.headers["X-Request-Id"])),a&&($request.headers?.["X-Session-Id"]&&($request.headers["X-Session-Id"]=t.headers["X-Session-Id"]),$request.headers?.["x-session-id"]&&($request.headers["x-session-id"]=t.headers["X-Session-Id"])),r&&($request.headers?.["X-Session-Digest"]&&($request.headers["X-Session-Digest"]=t.headers["X-Session-Digest"]),$request.headers?.["x-session-digest"]&&($request.headers["x-session-digest"]=t.headers["X-Session-Digest"])))}break;case t?.data?.accountId:i.info("PATHs[2]与accountId相同，更新Caches"),t.headers={"X-Request-Id":s,"X-Session-Id":a,"X-Session-Digest":r},h.setItem("@iRingo.TestFlight.Caches",t)}case"tc":}}else i.info("Caches空，新写入"),t.headers={"X-Request-Id":s,"X-Session-Id":a,"X-Session-Digest":r},/[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}/.test(f[2])&&(t.data={accountId:f[2],sessionId:a}),h.setItem("@iRingo.TestFlight.Caches",t)}else i.info("关闭多账号支持")}case"CONNECT":case"TRACE":}$request.url=g.toString(),i.debug(`$request.url: ${$request.url}`)})().catch(e=>i.error(e)).finally(()=>{switch(typeof e){case"object":if(e.headers?.["Content-Encoding"]&&(e.headers["Content-Encoding"]="identity"),e.headers?.["content-encoding"]&&(e.headers["content-encoding"]="identity"),"Quantumult X"===r)!e.status&&(e.status="HTTP/1.1 200 OK"),delete e.headers?.["Content-Length"],delete e.headers?.["content-length"],delete e.headers?.["Transfer-Encoding"],c(e);else c({response:e});break;case"undefined":c($request);break;default:i.error(`不合法的 $response 类型: ${typeof e}`)}})})();