name: Extract and Process Modules

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  Converting:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq netcat-openbsd

      - name: Wait for Docker services to be ready
        run: |
          echo "Waiting for Docker services to be ready..."
          for i in {1..10}; do
            nc -z localhost 9100 && nc -z localhost 9101 && break
            sleep 10
          done

      - name: Process Links and Download Files
        run: |
          category="Jacob"
          encoded_category=$(echo "$category" | jq -sRr @uri)
          
          # å¤„ç†æ¯ä¸ªé“¾æ¥
          while read -r module_link; do
            # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºç™½è¡Œ
            if [[ "$module_link" =~ ^\s*#.* ]] || [[ -z "${module_link// }" ]]; then
              continue
            fi
            
            # ç‰¹æ®ŠURL ğŸ˜‚ å¤„ç†
            encoded_module_link=$(echo "$module_link" | sed 's/ğŸ˜‚/%F0%9F%98%82/g')

            # è·å–ä½œè€…åï¼ˆå‡è®¾ä½œè€…åœ¨ URL ä¸­çš„ç¬¬4éƒ¨åˆ†ï¼‰
            author=$(echo "$module_link" | cut -d'/' -f4)
            filename_noext=$(basename "$module_link" | sed 's/\(.*\)\..*/\1/')
            encoded_filename=$(echo "$filename_noext" | jq -sRr @uri)
            
            # åˆ›å»ºæ–‡ä»¶å¤¹
            echo "Creating directories for $author"
            mkdir -p Modules/{Surge,Loon,Shadowrocket}/$author/Beta
            mkdir -p Modules/JS/$author/Beta

            # æ„å»ºæ¨¡å—çš„ URL
            Surge_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true"
            Surge_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=surge-module&category=${encoded_category}&nore=true&jqEnabled=true"
            Loon_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.plugin?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true"
            Loon_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.plugin?type=loon-plugin&target=loon-plugin&category=${encoded_category}&icon=Loon&nore=true&jqEnabled=true"
            Shadowrocket_url="http://localhost:9100/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true"
            Shadowrocket_Beta_url="http://localhost:9101/file/_start_/${encoded_module_link}/_end_/${encoded_filename}.sgmodule?type=surge-module&target=shadowrocket-module&category=${encoded_category}&nore=true&jqEnabled=true"

            # ä¸‹è½½å„æ¨¡å—æ–‡ä»¶
            echo "Downloading Surge file: $Surge_url"
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/$filename_noext.sgmodule" "$Surge_url" || echo "Failed to download $filename_noext.sgmodule"
            curl -A "Surge Mac/2985" -L -o "Modules/Surge/$author/Beta/$filename_noext.sgmodule" "$Surge_Beta_url" || echo "Failed to download $filename_noext.sgmodule"

            echo "Downloading Loon file: $Loon_url"
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/$filename_noext.plugin" "$Loon_url" || echo "Failed to download $filename_noext.plugin"
            curl -A "Surge Mac/2985" -L -o "Modules/Loon/$author/Beta/$filename_noext.plugin" "$Loon_Beta_url" || echo "Failed to download $filename_noext.plugin"

            echo "Downloading Shadowrocket file: $Shadowrocket_url"
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/$filename_noext.srmodule" "$Shadowrocket_url" || echo "Failed to download $filename_noext.srmodule"
            curl -A "Surge Mac/2985" -L -o "Modules/Shadowrocket/$author/Beta/$filename_noext.srmodule" "$Shadowrocket_Beta_url" || echo "Failed to download $filename_noext.srmodule"
          done < Links/Modules-Links.txt

      - name: Find and replace external JS resources
        continue-on-error: true  # ç¡®ä¿æ­¥éª¤åœ¨éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ
        run: |
          js_base_url="https://github.com/${GITHUB_REPOSITORY}/raw/main/Modules/JS"

          for sgmodule_file in $(find Modules/Surge/ \
              -mindepth 2 -type f -name "*.sgmodule" \
              ! -path "Modules/Surge/Kelee/*" \
              ! -path "Modules/Surge/NSRingo/*" \
              ! -path "Modules/Surge/BiliUniverse/*" \
              ! -path "Modules/Surge/DualSubs/*" \
              ! -path "Modules/Surge/VirgilClyne/*" \
              ! -path "*/Beta/*"); do
            # è·å–å½“å‰æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„
            author=$(dirname "$sgmodule_file" | sed 's|^Modules/Surge/||')
            module_folder=$(basename "$sgmodule_file" .sgmodule)
            echo "Processing $sgmodule_file from folder $author for JS links"

            # æŸ¥æ‰¾ .sgmodule æ–‡ä»¶ä¸­çš„ .js å’Œ .json é“¾æ¥ï¼ˆä¸å«#ï¼‰
            js_links=$(grep -v '#' "$sgmodule_file" | grep -oP 'https?://[^ ]+\.(json|js|jq)' || echo "")

            # ä¸‹è½½å’Œæ›¿æ¢æ¯ä¸ª JS é“¾æ¥
            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Modules/JS/$author/$module_folder/$js_filename"
              github_js_url="$js_base_url/$author/$module_folder/$js_filename"
              
              # åˆ›å»ºæ–‡ä»¶å¤¹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
              mkdir -p "$(dirname "$local_js_path")"

              # ä½¿ç”¨æŒ‡å®šçš„ User-Agent ä¸‹è½½ .js æ–‡ä»¶
              echo "Downloading $js_link to $local_js_path"
              if curl -A "Surge Mac/2985" -L -o "$local_js_path" "$js_link"; then
                echo "Download successful for $js_link"
                
                # è·å–å¯¹åº”çš„ Loon å’Œ Shadowrocket æ’ä»¶æ–‡ä»¶å
                surge_Beta_file="Modules/Surge/$author/Beta/$module_folder.sgmodule"
                loon_file="Modules/Loon/$author/$module_folder.plugin"
                loon_Beta_file="Modules/Loon/$author/Beta/$module_folder.plugin"
                shadowrocket_file="Modules/Shadowrocket/$author/$module_folder.srmodule"
                shadowrocket_Beta_file="Modules/Shadowrocket/$author/Beta/$module_folder.srmodule"

                # æ›¿æ¢æ–‡ä»¶ä¸­çš„ JS é“¾æ¥
                sed -i "s|$js_link|$github_js_url|g" "$sgmodule_file" && echo "Replaced $sgmodule_file"
                sed -i "s|$js_link|$github_js_url|g" "$surge_Beta_file" && echo "Replaced $surge_Beta_file"
                sed -i "s|$js_link|$github_js_url|g" "$loon_file" && echo "Replaced $loon_file"
                sed -i "s|$js_link|$github_js_url|g" "$loon_Beta_file" && echo "Replaced $loon_Beta_file"
                sed -i "s|$js_link|$github_js_url|g" "$shadowrocket_file" && echo "Replaced $shadowrocket_file"
                sed -i "s|$js_link|$github_js_url|g" "$shadowrocket_Beta_file" && echo "Replaced $shadowrocket_Beta_file"
              else
                echo "Failed to download $js_link, skipping..."
              fi
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–å½“å‰æ—¥æœŸï¼Œè®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
          DATE="$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
    
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add Modules/*
    
          # å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # æäº¤æ¶ˆæ¯ï¼ŒåŒ…å«åŠ¨æ€çš„æ—¥æœŸ
            COMMIT_MESSAGE="Converted modules at $DATE (UTC+8)"
      
            # ç¡®ä¿ä»“åº“æ˜¯æœ€æ–°çš„ï¼Œé¿å…å†²çª
            git stash
            git pull --rebase  # åŒæ­¥è¿œç¨‹ä»“åº“çš„æœ€æ–°æ›´æ”¹
            git stash pop  # æ¢å¤ä¹‹å‰çš„æ›´æ”¹
      
            # å†æ¬¡æ·»åŠ æ–‡ä»¶ï¼Œè¿›è¡Œæäº¤
            git add Modules/*
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
